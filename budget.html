<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Today</title>
    <link rel="icon" type="image/png" href="favicon.png"> 
    
    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        /* =================================================== */
        /* âœ¨ ë””ìì¸ ë³€ê²½: 10ëŒ€ì—ê²Œ ì–´í•„í•  ìˆ˜ ìˆëŠ” ì‚°ëœ»í•œ ìƒ‰ìƒ ë° ìŠ¤íƒ€ì¼ */
        /* =================================================== */
        :root {
            --main-bg: #f5f7fa; /* ë¼ì´íŠ¸ ê·¸ë ˆì´ ë°°ê²½ ìœ ì§€ */
            --main-accent: #0081a7; /* [ë³€ê²½ë¨] Vibrant Deep Aqua/Teal (í™œê¸°ì°¬ ë©”ì¸ ì»¬ëŸ¬) */
            --secondary-bg: #ffffff;
            --income-color: #38c172; /* [ë³€ê²½ë¨] ì‚´ì§ í€ì¹˜ ìˆëŠ” ê·¸ë¦° */
            --expense-color: #f15a5a; /* [ë³€ê²½ë¨] ì‚´ì§ í€ì¹˜ ìˆëŠ” ë ˆë“œ/í•‘í¬ */
            --text-color: #2c3e50;
            --shadow-light: 0 6px 10px rgba(0, 0, 0, 0.15); /* [ë³€ê²½ë¨] ë” ê¹Šì–´ì§„ ê·¸ë¦¼ì */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--main-bg);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .app-container {
            width: 100%;
            max-width: 800px;
            margin: 20px;
            padding: 20px;
            background-color: var(--secondary-bg);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        header h1 {
            color: var(--main-accent);
            margin-bottom: 5px;
            font-size: 2.2em; /* ì œëª© í°íŠ¸ í¬ê¸° ì¦ê°€ */
            font-weight: 900; /* ì œëª© ë‘ê»˜ ê°•ì¡° */
        }

        /* --- í˜ì´ì§€ë„¤ì´ì…˜/ë„¤ë¹„ê²Œì´ì…˜ --- */
        .navigation-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
            border-bottom: 2px solid var(--main-accent);
        }

        .nav-button {
            background-color: var(--main-accent);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); /* ë²„íŠ¼ ê·¸ë¦¼ì ì¶”ê°€ */
        }

        .nav-button:hover:not(:disabled) {
            background-color: #006b8c; /* ë©”ì¸ ìƒ‰ìƒë³´ë‹¤ ì–´ë‘¡ê²Œ */
        }

        .nav-button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        #pageIndicator {
            font-size: 1.1em;
            font-weight: bold;
        }

        /* --- ì¹´ë“œ ìŠ¤íƒ€ì¼ --- */
        .card {
            background-color: #f8f8f8;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ ì¡°ì • */
            box-shadow: var(--shadow-light);
        }

        .card h2 {
            color: var(--main-accent);
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.5em; /* ë¶€ì œëª© í°íŠ¸ í¬ê¸° ì¦ê°€ */
        }

        /* --- ì”ì•¡/í†µê³„ --- */
        .balance-summary {
            text-align: center;
            padding: 15px 0;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .balance-summary p {
            font-size: 1.1em;
            margin: 5px 0;
        }

        #currentBalance {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--text-color);
        }

        .monthly-stats {
            display: flex;
            justify-content: space-around;
            text-align: center;
            padding: 10px 0;
        }

        .monthly-stats div {
            flex-basis: 30%;
        }

        .income-text {
            color: var(--income-color);
            font-weight: bold;
        }

        .expense-text {
            color: var(--expense-color);
            font-weight: bold;
        }

        .balance-text {
            color: var(--main-accent);
            font-weight: bold;
        }

        /* --- ì…ë ¥ í¼ --- */
        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }

        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .action-buttons button {
            padding: 12px 18px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: bold;
        }

        #saveBudgetBtn {
            background-color: var(--income-color);
            color: white;
        }

        #saveBudgetBtn:hover {
            background-color: #31a364;
        }

        /* --- ì¥ë¶€ í…Œì´ë¸” --- */
        .monthly-ledger-container {
            margin-bottom: 30px;
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
        }

        .month-title {
            background-color: var(--main-accent);
            color: white;
            padding: 10px;
            font-weight: bold;
            font-size: 1.1em;
            text-align: center;
        }

        .month-summary {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background-color: #eef;
            border-bottom: 1px solid #ddd;
        }

        .ledger-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }

        .ledger-table th, .ledger-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        .ledger-table th {
            background-color: #f4f4f4;
            font-weight: bold;
        }

        .ledger-table tbody tr:hover {
            background-color: #f9f9f9;
        }

        .memo-cell {
            font-size: 0.9em;
            color: #666;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .action-cell {
            text-align: center;
            width: 80px;
        }

        .view-edit-btn {
            background-color: #f39c12;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }

        /* --- ëª©í‘œ ë° í†µê³„ ë·° --- */
        .goal-card {
            text-align: center;
        }

        .goal-actions {
            margin-top: 15px;
        }

        #goalMemoInput {
            resize: vertical;
            min-height: 100px;
        }

        #saveGoalBtn, #editGoalBtn {
            background-color: var(--main-accent);
            color: white;
        }

        #clearGoalBtn {
            background-color: var(--expense-color);
            color: white;
        }

        .five-year-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .year-slot {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .year-slot strong {
            display: block;
            margin-bottom: 10px;
            font-size: 1.1em;
            color: var(--text-color);
        }

        /* --- ëª¨ë‹¬ (ìˆ˜ì •/ì‚­ì œ) --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: var(--secondary-bg);
            margin: 15% auto;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 20px;
        }

        .modal-input-group {
            margin-bottom: 15px;
        }

        .modal-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .modal-input-group input,
        .modal-input-group select,
        .modal-input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .modal-actions {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-actions button {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            color: white;
        }

        #modalSaveBtn_new {
            background-color: var(--main-accent);
        }

        #modalDeleteBtn_new {
            background-color: var(--expense-color);
        }

        /* --- ì „ì—­ ì´ˆê¸°í™” ë²„íŠ¼ (3í˜ì´ì§€ ì „ìš©) --- */
        #globalActions {
            margin-top: 20px;
            text-align: right;
            display: none; /* JSì—ì„œ ì œì–´ */
        }

        #globalResetBtn {
            background-color: #830000;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        #globalResetBtn:hover {
            background-color: #c0392b;
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <h1>ğŸ’° Today Money ğŸ’¸</h1>
        <p class="balance-summary">
            ì´ ì”ì•¡: <span id="currentBalance">0ì›</span>
        </p>
    </header>

    <div class="navigation-bar">
        <button id="prevPageBtn" class="nav-button">ì´ì „</button>
        <span id="pageIndicator">í˜ì´ì§€ 1 / 3</span>
        <button id="nextPageBtn" class="nav-button">ë‹¤ìŒ</button>
    </div>

    <div id="mainViewContainer">
        <div id="recordView" class="page-content">
            <div class="card input-card">
                <h2>ğŸ“ ìƒˆ ê±°ë˜ ê¸°ë¡</h2>
                <div class="input-group">
                    <label for="budgetDate">ë‚ ì§œ</label>
                    <input type="date" id="budgetDate" required>
                </div>
                <div class="input-group">
                    <label for="budgetType">ìœ í˜•</label>
                    <select id="budgetType" required>
                        <option value="expense">ì§€ì¶œ</option>
                        <option value="income">ìˆ˜ì…</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="budgetAmount">ê¸ˆì•¡ (ì›)</label>
                    <input type="number" id="budgetAmount" placeholder="ê¸ˆì•¡" required min="1">
                </div>
                <div class="input-group">
                    <label for="budgetCategory">ì¹´í…Œê³ ë¦¬</label>
                    <select id="budgetCategory" required></select>
                </div>
                <div class="input-group">
                    <label for="budgetMemo">ë©”ëª¨ (ì„ íƒ)</label>
                    <textarea id="budgetMemo" placeholder="ê°„ë‹¨í•œ ë©”ëª¨"></textarea>
                </div>
                <div class="action-buttons">
                    <button id="saveBudgetBtn">ì €ì¥</button>
                    </div>
            </div>

            <div class="card">
                <h2>ğŸ“Š í˜„ì¬ ì›” í˜„í™©</h2>
                <div class="monthly-stats">
                    <div><p id="monthlyIncome" class="income-text">ìˆ˜ì…: 0ì›</p></div>
                    <div><p id="monthlyExpense" class="expense-text">ì§€ì¶œ: 0ì›</p></div>
                    <div><p id="monthlyBalance" class="balance-text">ì”ì•¡: 0ì›</p></div>
                </div>
                <canvas id="dailyExpenseChart"></canvas>
            </div>
        </div>

        <div id="monthlyLedgerView" class="page-content" style="display:none;">
            <div class="card">
                <h2>ğŸ“‘ ì›”ë³„ ì¥ë¶€ ëª©ë¡</h2>
                <div id="monthlyLedgersContent">
                    </div>
            </div>
        </div>

        <div id="goalAndStatsView" class="page-content" style="display:none;">
            <div class="card goal-card">
                <h2>ğŸ¯ ë‚˜ì˜ ëª©í‘œ</h2>
                <div class="input-group">
                    <label for="goalMemoInput">ì¥ê¸° ì¬ì • ëª©í‘œ ì„¤ì •</label>
                    <textarea id="goalMemoInput" placeholder="ì˜ˆ) 5ë…„ ì•ˆì— ì£¼íƒ ìê¸ˆ 5ì²œë§Œì› ëª¨ìœ¼ê¸°"></textarea>
                </div>
                <div class="goal-actions action-buttons">
                    <button id="saveGoalBtn">ëª©í‘œ ì €ì¥</button>
                    <button id="clearGoalBtn">ëª©í‘œ ì‚­ì œ</button>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ“ˆ 5ê°œë…„ ëˆ„ì  í†µê³„</h2>
                <div id="fiveYearStatsContent" class="five-year-stats">
                    </div>
            </div>
            
            <div id="globalActions" style="display:none;">
                <button id="globalResetBtn">âš ï¸ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™” (ì´ˆê¸°í™” í˜ì´ì§€)</button>
            </div>
        </div>
    </div>
</div>

<div id="budgetModal" class="modal">
    <div class="modal-content">
        </div>
</div>

<script>
// =========================================================================
// ğŸ§© JavaScript ë¡œì§ (BUDGET ì „ìš©) - V9 (ìˆ˜ì • ë²„íŠ¼ ë²„ê·¸ ìˆ˜ì • ì™„ë£Œ)
// =========================================================================

const db = new Dexie('BudgetAppDB');
db.version(2).stores({
    budgets: '++id, date, type, amount, category',
    goals: 'id',
});

let dailyExpenseChartInstance = null;
let currentPage = 1;
const totalPages = 3;

// --- DOM ìš”ì†Œ (ì£¼ì˜: ì•„ë˜ ë³€ìˆ˜ë“¤ì€ openBudgetModalì—ì„œ ì¬í• ë‹¹ë©ë‹ˆë‹¤! -> letìœ¼ë¡œ ì„ ì–¸) ---
// ì…ë ¥
const budgetDateInput = document.getElementById('budgetDate');
const budgetTypeInput = document.getElementById('budgetType');
const budgetAmountInput = document.getElementById('budgetAmount');
const budgetCategoryInput = document.getElementById('budgetCategory');
const budgetMemoInput = document.getElementById('budgetMemo');
const saveBudgetBtn = document.getElementById('saveBudgetBtn');
// ì¶œë ¥/í†µê³„
const currentBalanceEl = document.getElementById('currentBalance');
const monthlyLedgersContentEl = document.getElementById('monthlyLedgersContent');
const fiveYearStatsContentEl = document.getElementById('fiveYearStatsContent');
const monthlyIncomeEl = document.getElementById('monthlyIncome');
const monthlyExpenseEl = document.getElementById('monthlyExpense');
const monthlyBalanceEl = document.getElementById('monthlyBalance');

// ëª©í‘œ ì„¤ì •
const goalMemoInputEl = document.getElementById('goalMemoInput');
const saveGoalBtn = document.getElementById('saveGoalBtn');
const clearGoalBtn = document.getElementById('clearGoalBtn');

// ëª©í‘œ ë³´ê¸° ëª¨ë“œì— ì‚¬ìš©ë  ìš”ì†Œë“¤ (DOMì— ì•„ì§ ì—†ëŠ” ìš”ì†ŒëŠ” JSì—ì„œ ìƒì„±)
const goalDisplayArea = document.createElement('div');
goalDisplayArea.id = 'goalDisplayArea';
goalDisplayArea.style.whiteSpace = 'pre-wrap';
goalDisplayArea.style.minHeight = '120px';
goalDisplayArea.style.padding = '12px';
goalDisplayArea.style.border = '1px solid #ccc';
goalDisplayArea.style.borderRadius = '8px';
goalDisplayArea.style.backgroundColor = '#f9f9f9';

const editGoalBtn = document.createElement('button');
editGoalBtn.id = 'editGoalBtn';
editGoalBtn.textContent = 'ëª©í‘œ ìˆ˜ì •';
editGoalBtn.style.backgroundColor = 'var(--main-accent)';
editGoalBtn.style.color = 'white';
editGoalBtn.style.padding = '12px 18px';
editGoalBtn.style.borderRadius = '8px';
editGoalBtn.style.fontWeight = 'bold';
editGoalBtn.style.cursor = 'pointer';
editGoalBtn.style.border = 'none';
// ì…ë ¥ ë‚´ìš© ì´ˆê¸°í™” ë²„íŠ¼ (JSì—ì„œ ìƒì„±)
const clearInputBtn = document.createElement('button');
clearInputBtn.id = 'clearInputBtn';
clearInputBtn.textContent = 'ì…ë ¥ ë‚´ìš© ë¹„ìš°ê¸°';
clearInputBtn.style.backgroundColor = '#999';
clearInputBtn.style.color = 'white';
clearInputBtn.style.padding = '12px 18px';
clearInputBtn.style.borderRadius = '8px';
clearInputBtn.style.fontWeight = 'bold';
clearInputBtn.style.cursor = 'pointer';
clearInputBtn.style.border = 'none';
clearInputBtn.style.marginLeft = '10px';


// ê¸°ì¡´ DOM êµ¬ì¡° ì°¸ì¡°
const goalCardBody = document.querySelector('.goal-card');
const goalActionsDiv = document.querySelector('.goal-actions');
// í˜ì´ì§€ë„¤ì´ì…˜
const pageIndicator = document.getElementById('pageIndicator');
const mainViewContainer = document.getElementById('mainViewContainer');
const prevPageBtn = document.getElementById('prevPageBtn');
const nextPageBtn = document.getElementById('nextPageBtn');
// ì „ì²´ ì´ˆê¸°í™” ë²„íŠ¼ ì»¨í…Œì´ë„ˆ (ì œì–´ ëŒ€ìƒ)
const globalActionsDiv = document.getElementById('globalActions');


const budgetModal = document.getElementById('budgetModal');
const modalCloseBtn = document.getElementById('modalCloseBtn');
// â­â­ ëª¨ë‹¬ ë‚´ë¶€ì˜ ì…ë ¥ ìš”ì†Œë“¤: ì´ ë³€ìˆ˜ë“¤ì´ openBudgetModalì—ì„œ ìƒˆë¡œìš´ DOMì„ ì •í™•íˆ ì°¸ì¡°í•˜ë„ë¡ ì¬í• ë‹¹ë©ë‹ˆë‹¤. â­â­
let viewDateInput = document.getElementById('viewDate');
let viewTypeInput = document.getElementById('viewType');
let viewAmountInput = document.getElementById('viewAmount');
let viewCategoryInput = document.getElementById('viewCategory');
let viewMemoInput = document.getElementById('viewMemo');
const modalSaveBtn = document.getElementById('modalSaveBtn');
const modalDeleteBtn = document.getElementById('modalDeleteBtn');


let currentEditingId = null;
// ì¹´í…Œê³ ë¦¬ ëª©ë¡
const categories = {
    expense: [
        { value: 'ì‹ë¹„', label: 'ì‹ë¹„ ğŸ”' },
        { value: 'êµí†µ', label: 'êµí†µ ğŸšŒ' },
        { value: 'ì‡¼í•‘', label: 'ì‡¼í•‘ ğŸ›ï¸' },
        { value: 'ìƒí™œ', label: 'ìƒí™œ ğŸ ' },
        { value: 'ê²½ì¡°ì‚¬', label: 'ê²½ì¡°ì‚¬ ğŸ' },
        { value: 'ê¸°íƒ€_ì§€ì¶œ', label: 'ê¸°íƒ€ ì§€ì¶œ' }
    ],
    income: [
        { value: 'ì›”ê¸‰', label: 'ì›”ê¸‰ ğŸ’µ' },
        { value: 'ìš©ëˆ', label: 'ìš©ëˆ ğŸ’°' },
        { value: 'ë¶€ìˆ˜ì…', label: 'ë¶€ìˆ˜ì… âœ¨' },
        { value: 'ê¸°íƒ€_ìˆ˜ì…', label: 'ê¸°íƒ€ ìˆ˜ì…' }
    ]
};
// --- ìœ í‹¸ë¦¬í‹° ë° ì´ˆê¸°í™” í•¨ìˆ˜ ---
function getTodayDateString() {
    return new Date().toISOString().split('T')[0];
}

function formatAmount(amount) {
    return new Intl.NumberFormat('ko-KR').format(amount) + 'ì›';
}

function showToast(message) {
    console.log(`[Budget App] ${message}`);
}

function updateCategoryOptions(type, targetSelectElement) {
    targetSelectElement.innerHTML = '';
    const categoryList = categories[type] || categories.expense;
    categoryList.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.value;
        option.textContent = cat.label;
        targetSelectElement.appendChild(option);
    });
}

function clearInputFields() {
    budgetDateInput.value = getTodayDateString();
    budgetTypeInput.value = 'expense';
    budgetAmountInput.value = '';
    budgetMemoInput.value = '';
    updateCategoryOptions('expense', budgetCategoryInput);
}

// --- í˜ì´ì§€ë„¤ì´ì…˜ ë¡œì§ ---
function showPage(pageNumber) {
    currentPage = Math.min(Math.max(pageNumber, 1), totalPages);

    document.querySelectorAll('.page-content').forEach(el => el.style.display = 'none');
    let targetView;
    switch (currentPage) {
        case 1: targetView = document.getElementById('recordView'); break;
        case 2: targetView = document.getElementById('monthlyLedgerView');
                renderMonthlyLedgersView();
                break;
        case 3: targetView = document.getElementById('goalAndStatsView');
                calculateFiveYearStats();
                loadGoal();
                break;
    }

    if (targetView) {
        targetView.style.display = 'block';
    }

    pageIndicator.textContent = `í˜ì´ì§€ ${currentPage} / ${totalPages}`;

    prevPageBtn.disabled = (currentPage === 1);
    nextPageBtn.disabled = (currentPage === totalPages);
    // âœ¨ í•µì‹¬ ìˆ˜ì •: 3í˜ì´ì§€ì¼ ë•Œë§Œ ì „ì²´ ì´ˆê¸°í™” ë²„íŠ¼ ë³´ì´ê¸°
    if (currentPage === 3) {
        globalActionsDiv.style.display = 'block';
    } else {
        globalActionsDiv.style.display = 'none';
    }
}


// -------------------------------------------------------------------------
// 1. ê±°ë˜ ê¸°ë¡ CRUD
// -------------------------------------------------------------------------

async function saveBudget() {
    const date = budgetDateInput.value;
    const type = budgetTypeInput.value;
    const amount = parseInt(budgetAmountInput.value, 10);
    const category = budgetCategoryInput.value;
    const memo = budgetMemoInput.value.trim();
    const timestamp = new Date().getTime();

    if (!date || !type || !amount || !category || amount <= 0) {
        alert('í•„ìˆ˜ í•­ëª©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”. ê¸ˆì•¡ì€ 1ì› ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
    }

    try {
        await db.budgets.add({
            timestamp: timestamp,
            date: date,
            type: type,
            amount: amount,
            category: category,
            memo: memo
        });
        showToast(`[${date}] ${type === 'income' ? 'ìˆ˜ì…' : 'ì§€ì¶œ'} ${formatAmount(amount)} ì €ì¥ ì™„ë£Œ.`);
        clearInputFields();
        refreshAllData();
    } catch (error) {
        showToast('ê±°ë˜ ê¸°ë¡ ì €ì¥ ì˜¤ë¥˜: ' + error);
        console.error("Save Budget Error:", error);
    }
}


async function saveModalBudget() {
    if (!currentEditingId) return;
    const id = currentEditingId;

    // viewDateInput ë“±ì€ openBudgetModalì—ì„œ ìƒˆë¡œìš´ DOMì„ ê°€ë¦¬í‚¤ë„ë¡ ì¬í• ë‹¹ë¨
    const date = viewDateInput.value;
    const type = viewTypeInput.value;
    const amount = parseInt(viewAmountInput.value, 10);
    const category = viewCategoryInput.value;
    const memo = viewMemoInput.value.trim();

    if (!date || !type || !amount || !category || amount <= 0) {
        alert('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    try {
        const existingEntry = await db.budgets.get(id);
        await db.budgets.put({
            id: id,
            timestamp: existingEntry.timestamp,
            date: date,
            type: type,
            amount: amount,
            category: category,
            memo: memo
        });
        showToast(`ê±°ë˜ ê¸°ë¡ (ID: ${id}) ìˆ˜ì • ì™„ë£Œ.`);
        budgetModal.style.display = 'none';
        refreshAllData();
    } catch (error) {
        showToast('ê±°ë˜ ê¸°ë¡ ìˆ˜ì • ì˜¤ë¥˜: ' + error);
        console.error("Modal Save Error:", error);
    }
}

async function deleteBudgetEntry(id) {
    if (confirm('í•´ë‹¹ ê±°ë˜ ê¸°ë¡ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        try {
            await db.budgets.delete(id);
            showToast(`ê±°ë˜ ê¸°ë¡ (ID: ${id}) ì‚­ì œ ì™„ë£Œ`);
            budgetModal.style.display = 'none';
            refreshAllData();
        } catch (error) {
            showToast('ê±°ë˜ ê¸°ë¡ ì‚­ì œ ì˜¤ë¥˜: ' + error);
            console.error("Delete Budget Error:", error);
        }
    }
}

async function openBudgetModal(id) {
    currentEditingId = id;
    try {
        const entry = await db.budgets.get(id);
        if (!entry) {
            alert('ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const modalContent = document.getElementById('budgetModal').querySelector('.modal-content');
        // â­ í•µì‹¬ ìˆ˜ì • 1: ëª¨ë‹¬ HTMLì„ ìƒˆë¡œ êµ¬ì„±í•˜ê³ , ID ì¶©ëŒì„ í”¼í•˜ê¸° ìœ„í•´ '_new'ë¥¼ ì‚¬ìš©
        modalContent.innerHTML = `
            <span class="close-btn" id="modalCloseBtn_new">&times;</span>
            <h3>ê±°ë˜ ìˆ˜ì •/ë³´ê¸°</h3>
            <div class="modal-input-group">
                <label>ë‚ ì§œ</label>
                <input type="date" id="viewDate_new" required>
            </div>
            <div class="modal-input-group">
                <label>ìœ í˜•</label>
                <select id="viewType_new" required>
                    <option value="expense">ì§€ì¶œ</option>
                    <option value="income">ìˆ˜ì…</option>
                </select>
            </div>
            <div class="modal-input-group">
                <label>ê¸ˆì•¡ (ì›)</label>
                <input type="number" id="viewAmount_new" placeholder="ê¸ˆì•¡" required min="1">
            </div>
            <div class="modal-input-group">
                <label>ì¹´í…Œê³ ë¦¬</label>
                <select id="viewCategory_new" required></select>
            </div>
            <div class="modal-input-group">
                <label>ë©”ëª¨</label>
                <textarea id="viewMemo_new" placeholder="ë©”ëª¨"></textarea>
            </div>
            <div class="modal-actions">
                <button id="modalSaveBtn_new">ìˆ˜ì • ì™„ë£Œ</button>
                <button id="modalDeleteBtn_new">ì‚­ì œ</button>
            </div>
        `;

        // â­ í•µì‹¬ ìˆ˜ì • 2: ì „ì—­ 'let' ë³€ìˆ˜ë“¤ì— ìƒˆë¡œ ìƒì„±ëœ DOM ìš”ì†Œë¥¼ ì¬í• ë‹¹
        viewDateInput = modalContent.querySelector('#viewDate_new');
        viewTypeInput = modalContent.querySelector('#viewType_new');
        viewAmountInput = modalContent.querySelector('#viewAmount_new');
        viewCategoryInput = modalContent.querySelector('#viewCategory_new');
        viewMemoInput = modalContent.querySelector('#viewMemo_new');

        // ê°’ì„ ì±„ì›Œë„£ìŠµë‹ˆë‹¤.
        viewDateInput.value = entry.date;
        viewTypeInput.value = entry.type;
        viewAmountInput.value = entry.amount;
        viewMemoInput.value = entry.memo || '';

        // ì¹´í…Œê³ ë¦¬ ì˜µì…˜ì„ ì—…ë°ì´íŠ¸í•˜ê³  ì„ íƒí•©ë‹ˆë‹¤.
        updateCategoryOptions(entry.type, viewCategoryInput);
        viewCategoryInput.value = entry.category;

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ìƒˆë¡œ ì—°ê²°í•©ë‹ˆë‹¤.
        modalContent.querySelector('#modalSaveBtn_new').onclick = saveModalBudget;
        modalContent.querySelector('#modalDeleteBtn_new').onclick = () => deleteBudgetEntry(entry.id);
        modalContent.querySelector('#modalCloseBtn_new').onclick = () => budgetModal.style.display = 'none';

        // ìœ í˜• ë³€ê²½ ì‹œ ì¹´í…Œê³ ë¦¬ ì˜µì…˜ ì—…ë°ì´íŠ¸ ê¸°ëŠ¥ ì—°ê²°
        viewTypeInput.onchange = (e) => updateCategoryOptions(e.target.value, viewCategoryInput);

        budgetModal.style.display = 'block';

    } catch (error) {
        alert('ê±°ë˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        console.error("Open Modal Error:", error);
    }
}

// -------------------------------------------------------------------------
// 2. í†µê³„ ë° ì¥ë¶€ ë Œë”ë§
// -------------------------------------------------------------------------

async function calculateTotalBalance() {
    const allBudgets = await db.budgets.toArray();
    let income = 0;
    let expense = 0;

    allBudgets.forEach(entry => {
        if (entry.type === 'income') {
            income += entry.amount;
        } else {
            expense += entry.amount;
        }
    });

    const balance = income - expense;
    currentBalanceEl.textContent = formatAmount(balance);
}

// (í˜„ì¬ ì›”) í†µê³„ ì—…ë°ì´íŠ¸ ë° ì°¨íŠ¸ ë Œë”ë§
async function updateMonthlyStats() {
    const today = getTodayDateString();
    const currentMonth = today.substring(0, 7); // YYYY-MM
    const allBudgets = await db.budgets.toArray();

    const monthlyData = allBudgets.filter(entry => entry.date.startsWith(currentMonth));

    let income = 0;
    let expense = 0;
    const dailyExpenses = {}; // { 'YYYY-MM-DD': amount }

    monthlyData.forEach(entry => {
        if (entry.type === 'income') {
            income += entry.amount;
        } else {
            expense += entry.amount;
            dailyExpenses[entry.date] = (dailyExpenses[entry.date] || 0) + entry.amount;
        }
    });

    const balance = income - expense;

    monthlyIncomeEl.textContent = `ìˆ˜ì…: ${formatAmount(income)}`;
    monthlyExpenseEl.textContent = `ì§€ì¶œ: ${formatAmount(expense)}`;
    monthlyBalanceEl.textContent = `ì”ì•¡: ${formatAmount(balance)}`;

    renderDailyExpenseChart(dailyExpenses);
}

function renderDailyExpenseChart(dailyExpenses) {
    if (dailyExpenseChartInstance) {
        dailyExpenseChartInstance.destroy();
    }

    const dates = Object.keys(dailyExpenses).sort();
    const amounts = dates.map(date => dailyExpenses[date]);

    const ctx = document.getElementById('dailyExpenseChart').getContext('2d');
    dailyExpenseChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: dates.map(d => d.substring(5)), // ì›”/ì¼ë§Œ í‘œì‹œ
            datasets: [{
                label: 'ì¼ë³„ ì§€ì¶œ (ì›)',
                data: amounts,
                backgroundColor: 'rgba(234, 67, 53, 0.7)', // expense-color
                borderColor: 'rgba(234, 67, 53, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}


// ì›”ë³„ ì¥ë¶€ ëª©ë¡ (í˜ì´ì§€ 2) ë Œë”ë§
async function renderMonthlyLedgersView() {
    const allBudgets = await db.budgets.toArray();
    const monthlyLedgers = {}; // { 'YYYY-MM': [entries], ... }

    allBudgets.forEach(entry => {
        const month = entry.date.substring(0, 7);
        if (!monthlyLedgers[month]) {
            monthlyLedgers[month] = [];
        }
        monthlyLedgers[month].push(entry);
    });

    const sortedMonths = Object.keys(monthlyLedgers).sort().reverse();
    let html = '';

    if (sortedMonths.length === 0) {
        html = '<p style="text-align: center; color: #999; padding: 20px;">ê¸°ë¡ëœ ì›”ë³„ ì¥ë¶€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    } else {
        sortedMonths.forEach(month => {
            const entries = monthlyLedgers[month];
            let incomeTotal = 0;
            let expenseTotal = 0;

            entries.forEach(entry => {
                if (entry.type === 'income') incomeTotal += entry.amount;
                else expenseTotal += entry.amount;
            });

            html += `
                <div class="monthly-ledger-container">
                    <div class="month-title">${month} ì¥ë¶€</div>
                    <div class="month-summary">
                        <span class="income-text">ìˆ˜ì…: ${formatAmount(incomeTotal)}</span>
                        <span class="expense-text">ì§€ì¶œ: ${formatAmount(expenseTotal)}</span>
                        <span class="balance-text">ì”ì•¡: ${formatAmount(incomeTotal - expenseTotal)}</span>
                    </div>
                    ${generateLedgerTable(entries.sort((a, b) => new Date(b.date) - new Date(a.date)))}
                </div>
            `;
        });
    }

    monthlyLedgersContentEl.innerHTML = html;
    attachLedgerButtonListeners(); // í…Œì´ë¸” ìƒì„± í›„ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
}

function generateLedgerTable(entries) {
    let tableHtml = `
        <table class="ledger-table">
            <thead>
                <tr>
                    <th>ë‚ ì§œ</th>
                    <th>ë¶„ë¥˜</th>
                    <th>ê¸ˆì•¡</th>
                    <th>ë©”ëª¨</th>
                    <th>ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody>
    `;

    entries.forEach(entry => {
        const amountClass = entry.type; // 'income' or 'expense'
        const categoryLabel = categories[entry.type]?.find(cat => cat.value === entry.category)?.label || entry.category;

        tableHtml += `
            <tr>
                <td>${entry.date.substring(5)}</td>
                <td>${categoryLabel}</td>
                <td class="${amountClass}">${formatAmount(entry.amount)}</td>
                <td class="memo-cell">${entry.memo || '-'}</td>
                <td class="action-cell">
                    <button data-id="${entry.id}" class="view-edit-btn">ë³´ê¸°/ìˆ˜ì •</button>
                </td>
            </tr>
        `;
    });

    tableHtml += '</tbody></table>';
    return tableHtml;
}

function attachLedgerButtonListeners() {
    document.querySelectorAll('.view-edit-btn').forEach(button => {
        button.onclick = () => openBudgetModal(parseInt(button.getAttribute('data-id'), 10));
    });
}


// 5ê°œë…„ ëˆ„ì  í†µê³„ (í˜ì´ì§€ 3)
async function calculateFiveYearStats() {
    const currentYear = new Date().getFullYear();
    const allBudgets = await db.budgets.toArray();
    const annualStats = {}; // { 'YYYY': { income: 0, expense: 0 } }

    for (let i = 0; i < 5; i++) {
        annualStats[currentYear - i] = { income: 0, expense: 0 };
    }

    allBudgets.forEach(entry => {
        const year = parseInt(entry.date.substring(0, 4), 10);
        if (annualStats[year]) {
            if (entry.type === 'income') {
                annualStats[year].income += entry.amount;
            } else {
                annualStats[year].expense += entry.amount;
            }
        }
    });

    let html = '';
    const sortedYears = Object.keys(annualStats).sort((a, b) => b - a);

    if (sortedYears.length === 0) {
        html = '<div class="empty-message" style="text-align: center; color: #999; padding: 15px;">ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.</div>';
    } else {
        sortedYears.forEach(year => {
            const stats = annualStats[year];
            const balance = stats.income - stats.expense;

            html += `
                <div class="year-slot">
                    <strong>${year}ë…„ í†µê³„</strong>
                    <p class="income-text">ì´ ìˆ˜ì…: ${formatAmount(stats.income)}</p>
                    <p class="expense-text">ì´ ì§€ì¶œ: ${formatAmount(stats.expense)}</p>
                    <p class="balance-text" style="color: ${balance >= 0 ? 'var(--income-color)' : 'var(--expense-color)'};">ìˆœ ìì‚° ë³€í™”: ${formatAmount(balance)}</p>
                </div>
            `;
        });
    }

    fiveYearStatsContentEl.innerHTML = html;
}

// -------------------------------------------------------------------------
// 3. ëª©í‘œ ì„¤ì • ë¡œì§
// -------------------------------------------------------------------------

async function loadGoal() {
    try {
        const goalEntry = await db.goals.get(1); // goals í…Œì´ë¸”ì—ëŠ” ID 1 í•˜ë‚˜ë§Œ ì‚¬ìš©
        const goalText = goalEntry ? goalEntry.memo : '';

        // ëª©í‘œ ìƒíƒœì— ë”°ë¼ ë³´ê¸°/ìˆ˜ì • ëª¨ë“œ ì „í™˜
        if (goalText.trim() === '') {
            // ì…ë ¥ ëª¨ë“œ (ê¸°ì¡´ í¼ ë³´ì´ê¸°)
            goalMemoInputEl.value = '';
            goalMemoInputEl.style.display = 'block';
            if (goalDisplayArea.parentNode) {
                goalDisplayArea.parentNode.removeChild(goalDisplayArea);
            }
            // ë²„íŠ¼ ì•¡ì…˜
            goalActionsDiv.innerHTML = '';
            goalActionsDiv.appendChild(saveGoalBtn);
            goalActionsDiv.appendChild(clearGoalBtn);

        } else {
            // ë³´ê¸° ëª¨ë“œ (ì½ê¸° ì „ìš© í…ìŠ¤íŠ¸ ë³´ì´ê¸°)
            goalMemoInputEl.style.display = 'none';
            goalDisplayArea.textContent = goalText;

            if (!goalDisplayArea.parentNode) {
                goalCardBody.insertBefore(goalDisplayArea, goalActionsDiv);
            }

            // ë²„íŠ¼ ì•¡ì…˜: ìˆ˜ì • ë²„íŠ¼ë§Œ ë‚¨ê¸°ê¸°
            goalActionsDiv.innerHTML = '';
            goalActionsDiv.appendChild(editGoalBtn);
        }
    } catch (error) {
        console.error("Load Goal Error:", error);
    }
}

async function saveGoal() {
    const memo = goalMemoInputEl.value.trim();
    if (memo === '') {
        alert('ëª©í‘œ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    try {
        await db.goals.put({
            id: 1,
            memo: memo
        });
        showToast('ëª©í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadGoal(); // ì €ì¥ í›„ ë³´ê¸° ëª¨ë“œë¡œ ì „í™˜
    } catch (error) {
        showToast('ëª©í‘œ ì €ì¥ ì˜¤ë¥˜: ' + error);
        console.error("Save Goal Error:", error);
    }
}

async function clearGoal() {
    if (confirm('í˜„ì¬ ëª©í‘œë¥¼ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        try {
            await db.goals.delete(1);
            showToast('ëª©í‘œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadGoal(); // ì‚­ì œ í›„ ì…ë ¥ ëª¨ë“œë¡œ ì „í™˜
        } catch (error) {
            showToast('ëª©í‘œ ì‚­ì œ ì˜¤ë¥˜: ' + error);
            console.error("Clear Goal Error:", error);
        }
    }
}

function editGoal() {
    // ë³´ê¸° ëª¨ë“œì—ì„œ ì…ë ¥ ëª¨ë“œë¡œ ì „í™˜
    goalMemoInputEl.value = goalDisplayArea.textContent;
    goalMemoInputEl.style.display = 'block';
    if (goalDisplayArea.parentNode) {
        goalDisplayArea.parentNode.removeChild(goalDisplayArea);
    }
    // ë²„íŠ¼ ì•¡ì…˜: ì €ì¥/ì‚­ì œ ë²„íŠ¼ ë³´ì´ê¸°
    goalActionsDiv.innerHTML = '';
    goalActionsDiv.appendChild(saveGoalBtn);
    goalActionsDiv.appendChild(clearGoalBtn);
}


// -------------------------------------------------------------------------
// 4. ì „ì—­ ê´€ë¦¬ ë° ì´ˆê¸°í™”
// -------------------------------------------------------------------------

async function globalReset() {
    if (confirm('âš ï¸ ê²½ê³ : ëª¨ë“  ê±°ë˜ ê¸°ë¡(ìµœê·¼ 5ë…„ ë°ì´í„°)ì„ ì˜êµ¬ì ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        if (confirm('ì •ë§ë¡œ ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì‹ ì¤‘í•˜ê²Œ ê²°ì •í•´ì£¼ì„¸ìš”.')) {
            try {
                await db.budgets.clear();
                await db.goals.clear();
                showToast('âœ… ëª¨ë“  ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                refreshAllData();
                showPage(1); // ì´ˆê¸°í™” í›„ 1í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°
            } catch (error) {
                showToast('ë°ì´í„° ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error);
                console.error("Global Reset Error:", error);
            }
        }
    }
}


function refreshAllData() {
    calculateTotalBalance();
    updateMonthlyStats();
    // í˜„ì¬ í˜ì´ì§€ê°€ 2 ë˜ëŠ” 3ì´ë©´ í•´ë‹¹ í˜ì´ì§€ë„ ì—…ë°ì´íŠ¸
    if (currentPage === 2) renderMonthlyLedgersView();
    if (currentPage === 3) calculateFiveYearStats();
}

// -------------------------------------------------------------------------
// 5. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë° ì´ˆê¸°í™”
// -------------------------------------------------------------------------

function initializeEventListeners() {
    // 1. ì…ë ¥ í¼ ì´ë²¤íŠ¸
    budgetTypeInput.onchange = (e) => updateCategoryOptions(e.target.value, budgetCategoryInput);
    saveBudgetBtn.onclick = saveBudget;
    clearInputBtn.onclick = clearInputFields;
    // ì…ë ¥ í¼ì— ì´ˆê¸°í™” ë²„íŠ¼ ì¶”ê°€
    const inputCard = document.querySelector('.input-card');
    const saveBudgetBtnParent = saveBudgetBtn.parentNode;
    if (saveBudgetBtnParent) {
        saveBudgetBtnParent.appendChild(clearInputBtn);
    }


    // 2. í˜ì´ì§€ë„¤ì´ì…˜ ì´ë²¤íŠ¸
    prevPageBtn.onclick = () => showPage(currentPage - 1);
    nextPageBtn.onclick = () => showPage(currentPage + 1);

    // 3. ëª©í‘œ ì„¤ì • ì´ë²¤íŠ¸
    saveGoalBtn.onclick = saveGoal;
    clearGoalBtn.onclick = clearGoal;
    editGoalBtn.onclick = editGoal; // JSì—ì„œ ìƒì„±ëœ ë²„íŠ¼ì´ë¯€ë¡œ ì—¬ê¸°ì„œ ì—°ê²°

    // 4. ëª¨ë‹¬ ì´ë²¤íŠ¸ (ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°)
    window.onclick = function(event) {
        if (event.target == budgetModal) {
            budgetModal.style.display = "none";
        }
    }

    // 5. ì „ì²´ ì´ˆê¸°í™” ì´ë²¤íŠ¸ (3í˜ì´ì§€ìš©)
    document.getElementById('globalResetBtn').onclick = globalReset;

}

function init() {
    // 1. ì´ˆê¸° ë‚ ì§œ ì„¤ì •
    clearInputFields();

    // 2. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    initializeEventListeners();

    // 3. í˜ì´ì§€ ë·° ë¡œë“œ ë° ë°ì´í„° ìƒˆë¡œê³ ì¹¨
    refreshAllData();
    showPage(1);
}

// ì•± ì‹œì‘
init();
</script>
</body>
</html>