<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Today_diary</title>
    <script src="https://unpkg.com/dexie@3.2.3/dist/dexie.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        :root {
            --bg-light: #f7f9fc; 
            --main-accent: #4a90e2;
            --text-color: #333333;
            --card-background: #ffffff;
            --shadow-light: 0 4px 10px rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-light); 
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }
        
        .container {
            width: 100%;
            max-width: 600px; 
            padding: 20px;
        }

        h2 {
            text-align: center;
            color: var(--main-accent); 
            margin: 10px 0 20px;
            font-size: 1.8em; 
            font-weight: 600;
        }

        .write-card {
            background-color: var(--card-background); 
            padding: 20px; 
            border-radius: 15px;
            box-shadow: 0 0 0 2px var(--main-accent), var(--shadow-light); 
            margin-bottom: 30px;
        }

        .write-card h3 {
            border-bottom: 1px solid var(--main-accent); 
            padding-bottom: 10px;
            margin-top: 0;
            font-size: 1.2em;
            color: var(--text-color);
            font-weight: bold; 
        }

        #diaryTitleInput, #diaryTextInput {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            margin-bottom: 15px;
            outline: none;
            color: var(--text-color);
        }
        
        #diaryTextInput {
            min-height: 150px;
            resize: vertical;
            font-size: 1.1em; 
            font-weight: bold; 
        }
        
        #diaryTitleInput {
            font-weight: bold;
        }

        .mood-and-button {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }
        .mood-group {
            display: flex;
            align-items: center;
            font-size: 1em;
        }
        #moodSelect {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--main-accent); 
            background-color: white;
            font-size: 1em;
            margin-left: 10px;
        }

        #saveBtn {
            background-color: var(--main-accent); 
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: background-color 0.2s;
        }
        #saveBtn:hover {
            background-color: #3a75c4; 
        }

        .history-section h3 {
            border-bottom: 1px solid var(--main-accent); 
            padding-bottom: 10px;
            margin-top: 20px;
            font-size: 1.2em;
            color: var(--text-color);
            font-weight: bold; 
        }
        
        .diary-entry {
            background-color: var(--card-background);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-light);
            border-left: 5px solid var(--main-accent); 
        }
        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #666;
        }
        .entry-header strong {
            font-size: 1.1em;
            color: var(--text-color); 
            font-weight: bold;
        }
        
        .entry-content-short {
            margin: 5px 0 10px;
            white-space: pre-wrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3; 
            -webkit-box-orient: vertical;
            font-size: 1.1em; 
            font-weight: bold;
            color: var(--text-color);
        }
        
        .entry-actions button {
            background: #e0e0e0;
            color: var(--text-color);
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            margin-right: 5px;
        }
        .entry-actions button:hover {
            background: #ccc;
        }
        
        /* ë”ë³´ê¸° ë²„íŠ¼ */
        .show-more-btn {
            background-color: var(--main-accent);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            width: 100%;
            margin: 20px 0;
            transition: background-color 0.2s;
        }
        .show-more-btn:hover {
            background-color: #3a75c4;
        }
        
        /* í˜ì´ì§€ë„¤ì´ì…˜ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .pagination button {
            background-color: white;
            color: var(--main-accent);
            border: 2px solid var(--main-accent);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            min-width: 40px;
            transition: all 0.2s;
        }
        
        .pagination button:hover {
            background-color: var(--main-accent);
            color: white;
        }
        
        .pagination button.active {
            background-color: var(--main-accent);
            color: white;
        }
        
        .pagination button:disabled {
            background-color: #f0f0f0;
            color: #ccc;
            border-color: #ddd;
            cursor: not-allowed;
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 10; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5); 
        }
        .modal-content { 
            background-color: #fefefe; 
            margin: 10% auto; 
            padding: 30px; 
            border-radius: 15px; 
            width: 90%; 
            max-width: 500px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
        }
        .close-btn { 
            color: #aaa; 
            float: right; 
            font-size: 28px; 
            font-weight: bold; 
        }
        .close-btn:hover, .close-btn:focus { 
            color: #000; 
            text-decoration: none; 
            cursor: pointer; 
        }
        #viewTitle, #viewContent { 
            width: 100%; 
            padding: 10px; 
            margin-bottom: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            box-sizing: border-box; 
            font-size: 1em; 
            color: var(--text-color); 
        }
        #viewTitle { font-weight: bold; }
        #viewContent { min-height: 200px; resize: vertical; font-size: 1.1em; font-weight: bold; }
        .modal-actions { 
            display: flex; 
            justify-content: flex-end; 
            gap: 10px; 
        }
        .modal-actions button { 
            padding: 10px 15px; 
            border-radius: 8px; 
            font-weight: bold; 
        }
        #modalSaveBtn { background-color: var(--main-accent); color: white; }
        #modalDeleteBtn { background-color: #cc4444; color: white; }

        .search-section { 
            padding: 15px 0; 
            border-top: 1px solid var(--main-accent); 
        }
        .search-group { 
            display: flex; 
            gap: 10px; 
        }
        .search-group input { 
            flex-grow: 1; 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 5px; 
            box-sizing: border-box; 
            font-size: 1em; 
        }
        .search-group button { 
            flex-shrink: 0; 
            width: 60px; 
            background-color: var(--main-accent); 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: bold; 
        }
        #clearSearchBtn { 
            width: 80px; 
            background-color: #888; 
        }
        #clearSearchBtn:hover { 
            background-color: #666; 
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>ğŸ“ Today_diary</h2> 
        
        <div class="write-card">
            <h3>ì¼ê¸° ì‘ì„±</h3>
            
            <input type="text" id="diaryTitleInput" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
            <textarea id="diaryTextInput" placeholder="ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ê¸°ë¡í•´ ë³´ì„¸ìš”... (500ì ê¹Œì§€ë§Œ ê°€ëŠ¥)" maxlength="500"></textarea> 
            
            <div class="mood-and-button">
                <div class="mood-group">
                    <span>ì˜¤ëŠ˜ì˜ ê¸°ë¶„:</span>
                    <select id="moodSelect">
                        <option value="ğŸ˜Š">ì¢‹ìŒ ğŸ˜Š</option>
                        <option value="â˜€ï¸">ë§‘ìŒ â˜€ï¸</option>
                        <option value="ğŸŒ§ï¸">íë¦¼/ë¹„ ğŸŒ§ï¸</option>
                        <option value="ğŸ˜”">ìŠ¬í”” ğŸ˜”</option>
                        <option value="ğŸ˜¡">í™”ë‚¨ ğŸ˜¡</option>
                        <option value="ğŸ˜´">í”¼ê³¤ ğŸ˜´</option>
                    </select>
                </div>
                <button id="saveBtn">ìƒˆ ì¼ê¸° ì €ì¥</button>
            </div>
        </div>

        <div class="history-section">
            <h3>ìµœê·¼ ì¼ê¸° ëª©ë¡</h3>
            
            <div class="search-section">
                <div class="search-group">
                    <input type="text" id="searchKeyword" placeholder="ì œëª©/ë‚´ìš©/ë‚ ì§œ ê²€ìƒ‰">
                    <button onclick="renderDiaryHistory()">ê²€ìƒ‰</button>
                    <button id="clearSearchBtn">ëª©ë¡ìœ¼ë¡œ</button>
                </div>
            </div>

            <div id="historyList">
                <div class="empty-message" style="text-align: center; color: #999; padding: 15px;">ì‘ì„±ëœ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
            
            <button id="showMoreBtn" class="show-more-btn" style="display: none;">ë”ë³´ê¸° (10ê°œê¹Œì§€ ë³´ê¸°)</button>
            
            <div class="pagination" id="paginationContainer" style="display: none;"></div>
        </div>

        <div id="diaryModal" class="modal">
            <div class="modal-content">
                <span class="close-btn">&times;</span>
                <h3>ì¼ê¸° ìˆ˜ì •/ë³´ê¸°</h3>
                <p id="modalDate"></p>
                <input type="text" id="viewTitle" placeholder="ì œëª©ì„ ìˆ˜ì •í•˜ì„¸ìš”">
                <textarea id="viewContent" placeholder="ë‚´ìš©ì„ ìˆ˜ì •í•˜ì„¸ìš”"></textarea>
                <select id="viewMoodSelect">
                    <option value="ğŸ˜Š">ì¢‹ìŒ ğŸ˜Š</option>
                    <option value="â˜€ï¸">ë§‘ìŒ â˜€ï¸</option>
                    <option value="ğŸŒ§ï¸">íë¦¼/ë¹„ ğŸŒ§ï¸</option>
                    <option value="ğŸ˜”">ìŠ¬í”” ğŸ˜”</option>
                    <option value="ğŸ˜¡">í™”ë‚¨ ğŸ˜¡</option>
                    <option value="ğŸ˜´">í”¼ê³¤ ğŸ˜´</option>
                </select>
                <div class="modal-actions">
                    <button id="modalSaveBtn">ìˆ˜ì • ì™„ë£Œ</button>
                    <button id="modalDeleteBtn">ì‚­ì œ</button>
                </div>
            </div>
        </div>

    </div>

<script>
const db = new Dexie('DiaryAppDB');

db.version(1).stores({
    diaries: 'date, title, mood, content',
});
db.version(3).stores({
    diaries: '++id, date, timestamp, title, mood, content', 
}).upgrade(tx => {
    console.log("Database schema upgraded to version 3.");
});

// í˜ì´ì§• ë³€ìˆ˜
let currentDisplayMode = 'initial'; // 'initial' (3ê°œ), 'expanded' (10ê°œ), 'paginated' (í˜ì´ì§€)
let currentPage = 1;
const itemsPerPage = 10;
let allEntries = [];
let filteredEntries = [];

const diaryTitleInput = document.getElementById('diaryTitleInput');
const diaryTextInput = document.getElementById('diaryTextInput');
const moodSelect = document.getElementById('moodSelect');
const saveBtn = document.getElementById('saveBtn');
const historyList = document.getElementById('historyList');
const searchKeyword = document.getElementById('searchKeyword');
const clearSearchBtn = document.getElementById('clearSearchBtn'); 
const showMoreBtn = document.getElementById('showMoreBtn');
const paginationContainer = document.getElementById('paginationContainer');

const diaryModal = document.getElementById('diaryModal');
const closeBtn = document.querySelector('.close-btn');
const modalDate = document.getElementById('modalDate');
const viewTitle = document.getElementById('viewTitle');
const viewContent = document.getElementById('viewContent');
const viewMoodSelect = document.getElementById('viewMoodSelect');
const modalSaveBtn = document.getElementById('modalSaveBtn');
const modalDeleteBtn = document.getElementById('modalDeleteBtn');

let currentEditingId = null; 

function getTodayKey() {
    return new Date().toISOString().split('T')[0]; 
}

function showToast(message) {
    console.log(`[Diary App] ${message}`);
}

async function saveDiary() {
    const date = getTodayKey();
    const timestamp = new Date().getTime(); 
    const title = diaryTitleInput.value.trim();
    const content = diaryTextInput.value.trim();
    const mood = moodSelect.value;

    if (!title || !content) {
        alert('ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    try {
        await db.diaries.add({
            date: date,
            timestamp: timestamp,
            title: title, 
            mood: mood,
            content: content
        });
        showToast(`[${date}] ìƒˆ ì¼ê¸° ì €ì¥ ì™„ë£Œ.`);
        
        clearWriteInputs();
        currentDisplayMode = 'initial';
        renderDiaryHistory(); 
        
    } catch (error) {
        if (error.name === 'ConstraintError') {
             alert('âš ï¸ ì¼ê¸° ì €ì¥ ì‹¤íŒ¨: ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡° ì¶©ëŒ.');
        } else {
             alert('ì¼ê¸° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        showToast('ì¼ê¸° ì €ì¥ ì˜¤ë¥˜: ' + error);
        console.error("Save Diary Error:", error);
    }
}

function clearWriteInputs() {
    diaryTitleInput.value = '';
    diaryTextInput.value = '';
    moodSelect.value = 'ğŸ˜Š'; 
}

async function renderDiaryHistory() {
    historyList.innerHTML = '';
    const searchTerm = searchKeyword.value.toLowerCase().trim(); 

    allEntries = await db.diaries.orderBy('timestamp').reverse().toArray(); 
    
    if (searchTerm) {
        filteredEntries = allEntries.filter(entry => 
            entry.content.toLowerCase().includes(searchTerm) ||
            (entry.title ? entry.title.toLowerCase().includes(searchTerm) : false) || 
            entry.date.includes(searchTerm) 
        );
    } else {
        filteredEntries = allEntries;
    }
    
    if (filteredEntries.length === 0) {
        historyList.innerHTML = '<div class="empty-message" style="text-align: center; color: #999; padding: 15px;">' + 
            (searchTerm ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.' : 'ì‘ì„±ëœ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.') + 
            '</div>';
        showMoreBtn.style.display = 'none';
        paginationContainer.style.display = 'none';
        return;
    }

    let entriesToDisplay = [];
    
    if (currentDisplayMode === 'initial') {
        // ì²˜ìŒ 3ê°œë§Œ í‘œì‹œ
        entriesToDisplay = filteredEntries.slice(0, 3);
        showMoreBtn.style.display = filteredEntries.length > 3 ? 'block' : 'none';
        paginationContainer.style.display = 'none';
    } else if (currentDisplayMode === 'expanded') {
        // 10ê°œê¹Œì§€ í‘œì‹œ
        entriesToDisplay = filteredEntries.slice(0, 10);
        showMoreBtn.style.display = 'none';
        paginationContainer.style.display = filteredEntries.length > 10 ? 'flex' : 'none';
        if (filteredEntries.length > 10) {
            renderPagination();
        }
    } else if (currentDisplayMode === 'paginated') {
        // í˜ì´ì§€ë³„ë¡œ 10ê°œì”© í‘œì‹œ
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        entriesToDisplay = filteredEntries.slice(startIndex, endIndex);
        showMoreBtn.style.display = 'none';
        paginationContainer.style.display = 'flex';
        renderPagination();
    }

    entriesToDisplay.forEach(entry => {
        const entryElement = document.createElement('div');
        entryElement.className = 'diary-entry';
        
        const dateToUse = entry.timestamp || entry.date; 
        const dateObj = new Date(dateToUse); 
        const formattedDate = dateObj.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' });
        const formattedTime = dateObj.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

        entryElement.innerHTML = `
            <div class="entry-header">
                <strong>${formattedDate} (${formattedTime})</strong>
                <span>${entry.mood}</span>
            </div>
            <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 5px;">${entry.title || 'ì œëª© ì—†ìŒ'}</div>
            <div class="entry-content-short">${entry.content}</div>
            <div class="entry-actions">
                <button onclick="openDiaryModal(${entry.id}, 'view')">ë³´ê¸°</button>
                <button onclick="openDiaryModal(${entry.id}, 'edit')">ìˆ˜ì •</button>
                <button onclick="deleteDiaryEntry(${entry.id})">ì‚­ì œ</button>
            </div>
        `;
        historyList.appendChild(entryElement);
    });
}

function renderPagination() {
    paginationContainer.innerHTML = '';
    const totalPages = Math.ceil(filteredEntries.length / itemsPerPage);
    
    // ì´ì „ ë²„íŠ¼
    const prevBtn = document.createElement('button');
    prevBtn.textContent = 'â†';
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => goToPage(currentPage - 1);
    paginationContainer.appendChild(prevBtn);
    
    // í˜ì´ì§€ ë²ˆí˜¸
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, startPage + 4);
    
    for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.textContent = i;
        pageBtn.className = i === currentPage ? 'active' : '';
        pageBtn.onclick = () => goToPage(i);
        paginationContainer.appendChild(pageBtn);
    }
    
    // ë‹¤ìŒ ë²„íŠ¼
    const nextBtn = document.createElement('button');
    nextBtn.textContent = 'â†’';
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => goToPage(currentPage + 1);
    paginationContainer.appendChild(nextBtn);
}

function goToPage(page) {
    currentPage = page;
    currentDisplayMode = 'paginated';
    renderDiaryHistory();
    window.scrollTo(0, 0);
}

showMoreBtn.addEventListener('click', () => {
    currentDisplayMode = 'expanded';
    renderDiaryHistory();
});

async function deleteDiaryEntry(id) {
    if (confirm('í•´ë‹¹ ì¼ê¸°ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        try {
            await db.diaries.delete(id);
            showToast(`ì¼ê¸° (ID: ${id}) ì‚­ì œ ì™„ë£Œ`);
            
            diaryModal.style.display = 'none';
            renderDiaryHistory(); 
        } catch (error) {
            showToast('ì¼ê¸° ì‚­ì œ ì˜¤ë¥˜: ' + error);
            console.error("Delete Diary Error:", error);
        }
    }
}

async function openDiaryModal(id, mode) {
    currentEditingId = id; 
    
    try {
        const entry = await db.diaries.get(id);
        if (!entry) {
            alert('ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const dateToUse = entry.timestamp || entry.date;
        const dateObj = new Date(dateToUse); 
        const formattedDate = dateObj.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' });
        const formattedTime = dateObj.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        modalDate.textContent = `${formattedDate} (${formattedTime})`;

        viewTitle.value = entry.title || '';
        viewContent.value = entry.content;
        viewMoodSelect.value = entry.mood;

        if (mode === 'edit') {
            viewTitle.readOnly = false;
            viewContent.readOnly = false;
            viewMoodSelect.disabled = false;
            modalSaveBtn.style.display = 'inline-block';
            modalDeleteBtn.style.display = 'inline-block';
        } else {
            viewTitle.readOnly = true;
            viewContent.readOnly = true;
            viewMoodSelect.disabled = true;
            modalSaveBtn.style.display = 'none';
            modalDeleteBtn.style.display = 'none'; 
        }

        diaryModal.style.display = 'block';
    } catch (error) {
        showToast('ì¼ê¸° ë¡œë“œ ì˜¤ë¥˜: ' + error);
        console.error("Modal Load Error:", error);
    }
}

async function saveModalDiary() {
    if (!currentEditingId) return;
    
    const title = viewTitle.value.trim();
    const content = viewContent.value.trim();
    const mood = viewMoodSelect.value;
    const id = currentEditingId;

    if (!title || !content) {
        alert('ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    try {
        const existingEntry = await db.diaries.get(id);
        
        await db.diaries.put({
            id: id,
            date: existingEntry.date, 
            timestamp: existingEntry.timestamp,
            title: title, 
            mood: mood,
            content: content
        });
        showToast(`ì¼ê¸° (ID: ${id}) ìˆ˜ì • ì™„ë£Œ.`);
        
        diaryModal.style.display = 'none';
        renderDiaryHistory(); 
    } catch (error) {
        showToast('ì¼ê¸° ìˆ˜ì • ì˜¤ë¥˜: ' + error);
        console.error("Modal Save Error:", error);
    }
}

function clearSearchAndRender() {
    searchKeyword.value = ''; 
    currentDisplayMode = 'initial';
    currentPage = 1;
    renderDiaryHistory(); 
    showToast('ì „ì²´ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.');
}

function initializeApp() {
    clearWriteInputs(); 
    renderDiaryHistory(); 
    
    saveBtn.addEventListener('click', saveDiary);
    clearSearchBtn.addEventListener('click', clearSearchAndRender); 
    
    closeBtn.onclick = function() {
        diaryModal.style.display = 'none';
    }
    window.onclick = function(event) {
        if (event.target == diaryModal) {
            diaryModal.style.display = 'none';
        }
    }
    modalSaveBtn.addEventListener('click', saveModalDiary);
    modalDeleteBtn.addEventListener('click', () => {
        if (currentEditingId) {
            deleteDiaryEntry(currentEditingId);
        }
    });

    searchKeyword.addEventListener('input', () => {
        currentDisplayMode = 'initial';
        currentPage = 1;
        renderDiaryHistory();
    }); 
}

window.onload = initializeApp;

</script>

</body>
</html>